<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Roboto&display=swap" rel="stylesheet">

  <style>
body {
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(135deg, #ffdde1, #ee9ca7);
  background-attachment: fixed;
  background-size: cover;
  min-height: 100vh;
  margin: 0;
  padding: 0;
}

.container {
  max-width: 1100px;
  padding-top: 40px;
  padding-bottom: 40px;
}

/* Banner */
.dashboard-banner {
  background: linear-gradient(90deg, #ff4d6d, #f8a5c2);
  color: #fff;
  padding: 25px 35px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 15px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  margin-bottom: 30px;
}

.dashboard-banner h2 {
  margin: 0;
  font-family: 'Montserrat', sans-serif;
  font-weight: 600;
  font-size: 28px;
}

.dashboard-banner p {
  margin: 0;
  font-size: 16px;
}

/* Glassy Card styling */
.card-stat,
.property-card,
.appliance-card,
.alert-custom {
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  padding: 20px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  margin-bottom: 25px;
}

.card-stat:hover,
.property-card:hover,
.appliance-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.card-stat h5 {
  font-weight: 600;
  color: #ff4d6d;
  margin-bottom: 10px;
}

.card-stat p {
  font-size: 32px;
  font-weight: bold;
  color: #222;
  margin: 0;
}

/* Section titles */
.section-title {
  font-weight: 600;
  color: #ff4d6d;
  margin-bottom: 20px;
}

/* Appliance card tweaks */
.appliance-card {
  display: flex;
  align-items: center;
  gap: 15px;
}

.appliance-card img {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  object-fit: cover;
  border: 1px solid rgba(255,255,255,0.3);
  background-color: rgba(255,255,255,0.2);
  flex-shrink: 0;
}

.appliance-title {
  font-weight: 600;
  font-size: 18px;
  color: #222;
  margin-bottom: 6px;
}

.appliance-detail {
  font-size: 14px;
  color: #333;
  margin-bottom: 3px;
}

.badge-status {
  font-size: 13px;
  font-weight: 500;
  padding: 5px 8px;
  border-radius: 8px;
}

/* Alerts */
.alert-custom {
  border-left: 5px solid #ff4d6d;
}

/* Logout button */
.logout-btn {
  border: none;
  background: linear-gradient(90deg, #ff4d6d, #ff758c);
  color: #fff;
  font-size: 16px;
  padding: 12px 25px;
  border-radius: 8px;
  transition: transform 0.3s ease;
  text-decoration: none;
}

.logout-btn:hover {
  transform: translateY(-3px);
}

  </style>
</head>
<body>
  <div class="container">

    <!-- Banner -->
    <div class="dashboard-banner">
      <div>
        <h2><i class="bi bi-tools"></i> Dashboard</h2>
        <p>Welcome, <strong>{{ user.username }}</strong> ({{ user.role|capitalize }})</p>
      </div>
    </div>

    <!-- Total Appliances -->
    <div class="card-stat">
      <h5><i class="bi bi-plug-fill"></i> Total Appliances</h5>
      <p>{{ total_appliance_count }}</p>
    </div>

    <!-- Warranty Alerts -->
    {% if expiry_alerts %}
      <div class="alert-custom">
        <h5><i class="bi bi-exclamation-triangle-fill"></i> Warranty Expiry Alerts</h5>
        <ul class="mb-0">
          {% for alert in expiry_alerts %}
            <li>
              <strong>{{ alert.name }}</strong> ({{ alert.model }}) in <strong>{{ alert.property_name }}</strong> ‚Äì
              {% if alert.status == 'expired' %}
                <span class="badge bg-danger badge-status">Expired on {{ alert.expiry }}</span>
              {% elif alert.status == 'expiring_soon' %}
                <span class="badge bg-warning text-dark badge-status">Expiring on {{ alert.expiry }}</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Assigned Properties -->
    <h4 class="section-title"><i class="bi bi-buildings"></i> Assigned Properties</h4>
    {% if properties %}
      <div class="row g-4 mb-5">
        {% for prop in properties %}
          <div class="col-md-6">
            <div class="property-card">
              <h5><i class="bi bi-building"></i> {{ prop.name }}</h5>
              <p class="text-muted"><i class="bi bi-geo-alt"></i> {{ prop.address }}</p>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No properties assigned yet.</p>
    {% endif %}

    <!-- Reported Issues Section -->
<h4 class="section-title"><i class="bi bi-exclamation-circle"></i> Reported Issues</h4>

{% if issues %}
  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-danger">
        <tr>
          <th>ID</th>
          <th>Description</th>
          <th>Tenant</th>
          <th>Property</th>
          <th>Status</th>
          <th>Vendor</th>
          <th>Cost</th>
          <th>Bill</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for issue in issues %}
          <tr>
            <td>{{ issue.id }}</td>
            <td>{{ issue.description }}</td>
            <td>{{ issue.tenant.username }}</td>
            <td>{{ issue.property.name }}</td>
            <td>
              {% if issue.status == "pending" %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% elif issue.status == "assigned" %}
                <span class="badge bg-info">Assigned</span>
              {% elif issue.status == "completed" %}
                <span class="badge bg-primary">Completed</span>
              {% elif issue.status == "verified" %}
                <span class="badge bg-success">Verified</span>
              {% endif %}
            </td>
            <td>{{ issue.vendor.name if issue.vendor else "Not Assigned" }}</td>
            <td>‚Çπ{{ issue.cost if issue.cost else "N/A" }}</td>
            <td>
              {% if issue.bill_url %}
                <a href="{{ url_for('static', path=issue.bill_url) }}" target="_blank" class="btn btn-sm btn-secondary">View Bill</a>
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>
              <!-- Assign Vendor (only if pending) -->
              {% if issue.status == "pending" %}
              <form method="post" action="/issues/{{ issue.id }}/assign" class="d-flex gap-2">
                <select name="vendor_id" class="form-select form-select-sm" required>
                  <option value="">Select Vendor</option>
                  {% for vendor in vendors %}
                    <option value="{{ vendor.id }}">{{ vendor.name }} ({{ vendor.service_type }})</option>
                  {% endfor %}
                </select>
                <input type="number" step="0.01" name="cost" placeholder="Cost" class="form-control form-control-sm" required>
                <button type="submit" class="btn btn-sm btn-primary">Assign</button>
              </form>
              {% endif %}

              <!-- Verify Issue (after vendor uploads bill) -->
              {% if issue.status == "completed" %}
              <form method="post" action="/issues/{{ issue.id }}/verify">
                <button type="submit" class="btn btn-sm btn-success">Verify</button>
              </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p class="text-muted">No issues reported yet.</p>
{% endif %}


<!-- Appliances per Property -->
<h4 class="section-title"><i class="bi bi-plug-fill"></i> Appliances per Property</h4>
{% for prop in properties %}
  <div class="property-card mb-4">
    <h5><i class="bi bi-building"></i> {{ prop.name }}</h5>
    <p class="text-muted"><i class="bi bi-geo-alt"></i> {{ prop.address }}</p>
    {% set appliance_list = appliances_per_property.get(prop.id, []) %}
    {% if appliance_list %}
      <div class="row g-3 mt-3">
        {% for app in appliance_list %}
          <div class="col-md-6">
            <div class="appliance-card">
              <img src="{% if app.front_image %}
                         {{ url_for('static', path='uploads/' ~ app.front_image) }}
                       {% elif app.name|lower == 'refrigerator' %}
                         {{ url_for('static', path='uploads/refrigerator_default_appliance.jpg') }}
                       {% else %}
                         {{ url_for('static', path='uploads/default_appliance.jpg') }}
                       {% endif %}"
                   alt="{{ app.name }}"
                   class="img-fluid rounded">
              <div>
                <div class="appliance-title"><i class="bi bi-lightning-charge-fill"></i> {{ app.name }}</div>
                <div class="appliance-detail"><strong>Model:</strong> {{ app.model }}</div>
                <div class="appliance-detail"><strong>Color:</strong> {{ app.color }}</div>
                <div class="appliance-detail">
                  <strong>Status:</strong>
                  {% if app.status.lower() == 'working' %}
                    <span class="badge bg-success badge-status">Working</span>
                  {% else %}
                    <span class="badge bg-danger badge-status">{{ app.status }}</span>
                  {% endif %}
                </div>
                <div class="appliance-detail"><strong>Warranty:</strong> {{ app.warranty_expiry.strftime('%Y-%m-%d') if app.warranty_expiry else 'N/A' }}</div>
                <div class="appliance-detail"><strong>üìç Location:</strong> {{ app.location if app.location else 'N/A' }}</div>

                <!-- VIEW + EDIT BUTTONS -->
                <div class="mt-2 d-flex gap-2">
                  <!-- View Details -->
                  <a href="{{ url_for('appliance_detail', appliance_id=app.id) }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-eye"></i> View Details
                  </a>

                  <!-- Edit Appliance (only for owner or manager) -->
                  {% if user.role in ["owner", "manager"] %}
                  <a href="{{ url_for('edit_appliance_page', appliance_id=app.id) }}" class="btn btn-sm btn-success">
                    <i class="bi bi-pencil-square"></i> Edit
                  </a>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mt-2">No appliances added for this property yet.</p>
    {% endif %}
  </div>
{% endfor %}

    <!-- Logout -->
    <div class="text-center my-5">
      <a href="/logout" class="logout-btn"><i class="bi bi-box-arrow-right"></i> Logout</a>
    </div>

  </div>
</body>
</html>
